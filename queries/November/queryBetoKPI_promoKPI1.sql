select
    base_data.country_code,
    base_data.priority,
    sum(
        case
            WHEN promo_percentage.orders_with_promo_percentage > 0.4 then 1
            else 0
        end
    ) / count(*) as promo_effectiveness_percentage
from
    (
        select
            shop_id,
            priority,
            country_code
        from
            soda_international_dwm.dwm_bizopp_wide_d_whole
        where
            country_code in ('MX', 'CO', 'PE', 'CR')
            and concat_ws('-', year, month, day) = '2024-09-30'
            and priority in ('Priority 1', 'Priority 2', 'Priority 3')
            and shop_id in (
                "5764607610448511499",
                "5764607662185251049",
                "5764607781911659259",
                "5764607524263952617",
                "5764607605973188842",
                "5764607626638524650",
                "5764607643247968488",
                "5764607718422479079",
                "5764607773636300632",
                "5764607597899153643",
                "5764607770285048039",
                "5764607566576091371",
                "5764607558934071416",
                "5764607642019037417",
                "5764607568992010471",
                "5764607681013481706",
                "5764607587904130245",
                "5764607658867558928",
                "5764607814664978482",
                "5764607797707407588",
                "5764607772902295402",
                "5764607753008711381",
                "5764607782092013796",
                "5764607590001279209",
                "5764607603775375426",
                "5764607612700852459",
                "5764607688055718119",
                "5764607564629934404",
                "5764607666832542431",
                "5764607723891851344",
                "5764607551162026611",
                "5764607955077694243",
                "5764607780397515340",
                "5764607749892345842",
                "5764607632732850551",
                "5764607706263191784",
                "5764607527808142302",
                "5764607643772256488",
                "5764607674180963179",
                "5764607626105848039",
                "5764607731651313980",
                "5764607667948227279",
                "5764607724068014110",
                "5764607596724749116",
                "5764607591679003557",
                "5764607744980812100",
                "5764607528730886377",
                "5764607537488593962",
                "5764607742485201128",
                "5764607705944426904",
                "5764607610809221352",
                "5764607596263378323",
                "5764607765906194964",
                "5764607581818192106",
                "5764607595005086614",
                "5764607911142359455",
                "5764607750404049585",
                "5764607739431750790",
                "5764607649266798053",
                "5764607739154923885",
                "5764607740161558748",
                "5764607593163784601",
                "5764607786844160230",
                "5764607796604305638",
                "5764607948484248115",
                "5764607535739569097",
                "5764607633936613861",
                "5764607768712184042",
                "5764607547475233713",
                "5764607751729450147",
                "5764607724600689765",
                "5764607535227864841",
                "5764607701666234601",
                "5764607622419054824",
                "5764607668174718720",
                "5764607837268083695",
                "5764607691444716224",
                "5764607766405316842",
                "5764607770238913441",
                "5764607752081772103",
                "5764607735287776321",
                "5764607761737056483",
                "5764607766673752298",
                "5764607569059119338",
                "5764607581847552330",
                "5764607563551998702",
                "5764607772411560168",
                "5764607702001781164",
                "5764607534028294255",
                "5764607545210309886",
                "5764607675288256745",
                "5764607698038161641",
                "5764607612772155624",
                "5764608045741769562",
                "5764607604584876120",
                "5764607693709642362",
                "5764607788870009063",
                "5764607690727492197",
                "5764607637858290243",
                "5764607914317448675",
                "5764607545709428968",
                "5764607635282987962",
                "5764607748566941926",
                "5764607580417294570",
                "5764607561622618345",
                "5764607542605644011",
                "5764607665968513257",
                "5764607599052587241",
                "5764607786676391911",
                "5764607752752857518",
                "5764607767600696101",
                "5764607690937206690",
                "5764607578777323339",
                "5764607677339274090",
                "5764607549467527971",
                "5764608018982109192",
                "5764607672457101544",
                "5764607973536826644",
                "5764607559223479783",
                "5764607771354595561",
                "5764607554525856383",
                "5764607598779957483",
                "5764607570015424039",
                "5764607592056488166",
                "5764608020257178407",
                "5764607644577562856",
                "5764607765885223146",
                "5764607790015054055",
                "5764607742233544788",
                "5764607845006574631",
                "5764608031095260895",
                "5764607874760967842",
                "5764607959838228628",
                "5764607800005887426",
                "5764607996559362011",
                "5764607937633584858",
                "5764608046341555959",
                "5764607868737946955",
                "5764607576856334291",
                "5764607852757647506",
                "5764607801662636144",
                "5764607881933227892",
                "5764608071385745511"
            )
    ) as base_data
    left join (
        select
            shop_id,
            COUNT(
                DISTINCT CASE
                    WHEN status = 600
                    AND is_td_complete = 1
                    AND e_activityinfo_totalfavourprice > 0
                    AND (
                        (
                            e_couponinfo_batch_id IS NOT NULL
                            AND e_couponinfo_deduction_amount > 0
                        )
                        or (
                            e_couponinfo_batch_id IS NULL
                            AND e_couponinfo_deduction_amount IS NULL
                        )
                    ) THEN order_id
                END
            ) / COUNT(
                DISTINCT CASE
                    WHEN status = 600
                    AND is_td_complete = 1 THEN order_id
                END
            ) AS orders_with_promo_percentage
        FROM
            soda_international_dwd.dwd_order_wide_d_increment
        WHERE
            country_code in ('MX', 'CO', 'CR', 'PE')
            AND concat_ws('-', year, month, day) between '2024-09-01'
            AND '2024-09-30'
            AND to_date(complete_time_local) between '2024-09-01'
            AND '2024-09-30'
        group by
            shop_id
        having
            COUNT(
                DISTINCT CASE
                    WHEN status = 600
                    AND is_td_complete = 1 THEN order_id
                END
            ) >= 5
    ) as promo_percentage on promo_percentage.shop_id = base_data.shop_id
group BY
    base_data.country_code,
    base_data.priority
order by
    base_data.country_code,
    base_data.priority;